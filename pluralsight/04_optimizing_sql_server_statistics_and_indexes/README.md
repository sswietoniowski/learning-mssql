# Optimizing SQL Server Statistics and Indexes

Introduction to SQL Server Statistics and Indexes

## 1. Overview of Index Maintenance

We need to maintain our indexes to reduce its fragmentation also we might need to update statistics to improve query performance.

Maintenance:

- cleanup,
- out of peak time,
- determined by workload.

There are other maintenance tasks that we can (and should) do: backups and consistency checks.

## 2. Review Index Usage and Identify Potential Missing Indexes

Why do we need to maintain indexes?

Main reasons:

- workload changes,
- data changes,
- schema changes.

First we need to know how to review index usage:

- identify missing indexes,
- identify unused indexes,
- identify redundant indexes.

### Missing Indexes

To identify missing indexes we can use:

- Dynamic Management Views (DMVs),
- Database Tuning Advisor (DTA).

They both produce **recommendations** which we should review (carefully) and implement (if really needed).

Missing Index DMVs are:

- automatically tracked,
- generated by the Query Optimizer,
- limited in what is considered (compared to DTA),
- won't recommended clustered indexes, partitioning and columnstore indexes, unique constraints or unique indexes,

Missing Index DMVs objects:

- `sys.dm_db_missing_index_groups` - groups of missing indexes,
- `sys.dm_db_missing_index_group_stats` - statistics about missing indexes,
- `sys.dm_db_missing_index_details` - details about missing indexes.

To know whether we're missing some indexes we can use:

```sql
SELECT DB_NAME(mid.database_id) AS DatabaseName,
       OBJECT_SCHEMA_NAME(mid.object_id, mid.database_id) AS SchemaName,
       OBJECT_NAME(mid.object_id, mid.database_id) AS ObjectName,
       migs.avg_user_impact,
       mid.equality_columns,
       mid.inequality_columns,
       mid.included_columns
FROM sys.dm_db_missing_index_groups mig
    INNER JOIN sys.dm_db_missing_index_group_stats migs
        ON migs.group_handle = mig.index_group_handle
    INNER JOIN sys.dm_db_missing_index_details mid
        ON mig.index_handle = mid.index_handle;
```

Interpreting the results:

- `avg_user_impact` - average impact of the missing index on the query performance,
- `equality_columns` - columns used in the `WHERE` clause,
- `inequality_columns` - columns used in the `WHERE` clause with inequality operators,
- `included_columns` - columns used in the `SELECT` clause.

Recommendations are for the most part to create a covering index - as such they can be quite
expensive (if applied without proper review).

Limitations of Missing Index DMVs:

- can recommended partially duplicate indexes,
- evaluated per-query, not on entire workload,
- limited in how many suggestions are kept,
- lost when the server restarts.

### Database Tuning Advisor

Database Tuning Advisor (DTA) is a tool that can help us with finding missing indexes.

### Unused Indexes

We need to know whether our indexes are used or not.

We can use `sys.dm_db_index_usage_stats` to find out.

```sql
SELECT
    object_name(object_id) AS [Table],
    index_id,
    user_seeks,
    user_scans,
    user_lookups,
    last_user_seek,
    last_user_scan,
    last_user_lookup
FROM sys.dm_db_index_usage_stats
WHERE database_id = DB_ID()
ORDER BY user_seeks DESC
```

### Redundant Indexes

## 3. Maintaining Rowstore Indexes

## 4. Maintaining Columnstore Indexes

## 5. Maintaining Statistics

## Summary
