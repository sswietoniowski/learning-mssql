# Analyzing SQL Server Query Plans

Introduction to SQL Server Query Plans

## 1. Capture Query Plans Using Extended Events and Traces

To diagnose performance issues, you need to capture query plans. In this module, you will learn how to capture query plans using Extended Events and Traces.

### What is a Query Plan?

> A query plan (or query execution plan) is an ordered set of steps used to access data in a SQL relational management system.

SQL language is declarative and thus there are many ways to execute our queries.

SQL Server uses a query plan to determine the best way to execute a query. The query plan is a set of steps that SQL Server uses to access data in the database. The query plan is generated by the query optimizer. The query optimizer is a component of SQL Server that determines the best way to execute a query. The query optimizer uses statistics and other information to determine the best way to execute a query. The query optimizer uses the query plan to determine the best way to execute a query.

### Query Execution Plan Stages

Query execution plan stages:

1. **query parsing**,
2. **query optimization**,
3. **query execution**,
4. **query plan cached**.

### Why Analyze Query Plans?

Main reasons to analyze query plans:

1. identify expensive operators,
2. understand the data flow,
3. diagnose blocking operators,
4. determine state of statistics,
5. classify resource consumption.

Short answer:

> To identify root cause of our poor performance we must analyze query plans.

In SSMS we can have three different ways to see execution plans:

- graphical view (default, enabled by `^M`),
- textual view (to see it we must use `SET STATISTICS PROFILE ON`),
- XML view (to see it we must use `SET STATISTICS XML ON`).

### How to Analyze Query Plans?

To analyze query plans we can use:

- SQL Profiler (old and famous),
- SQL Trace (deprecated),
- Extended Events (new and powerful),
- Query Store (new and powerful).

### What is SQL Profiler?

> SQL Profiler is graphical user interface to SQL Trace to monitor various events running on a SQL Server instance.

SQL Profiler is resource intensive and it is not recommended to use it in production environment.

SQL traces gather events at the instance level and report them efficiently to users. SQL Profiler can create traces. SQL traces were great until MS decided to deprecated them.

### What are Extended Events?

Extended Events are a new feature in SQL Server 2008. Extended Events are a lightweight monitoring
tool which collects data about inner operations of SQL Server and helps troubleshoot performance
problems.

Compared to SQL Profiler, Extended Events are:

- lightweight on resources,
- extensive server events,
- portable.

## 2. Identify Poorly Performing Query Plan Operators

We know how to gather query plans, now its time to analyze them. In this module, you will learn how to identify poorly performing query plan operators.

### What is a Query Execution Plan?

> A query execution plan is a visual representation of operations performed by SQL Server
> engine to return the valid data for the query.

### Interpreting Execution Plans

While interpreting a query plan:

- read it from right to left,
- look at operators' costs,
- see the data flow,
- look for warnings,
- look for suggestions/hints,
- query cost in batch.

Also add to the picture:

- statistics IO,
- statistics TIME.

### Slow Performing Operators

Main operators that we should look for are:

1. **Table Scan** - not bad per se, but we would rather want to see a **Seek** operator,
2. **Index Scan** - same as above,
3. **Parallelism** - again, not bad per se, but why we need to process so much data in parallel?
4. **Sort** - we should avoid sorting if possible, but sometimes it is necessary, it is possible that sorting is added just for merging data, also we should look for **Sort Spill** operator,
5. **Implicit Conversion** - we should avoid situations in which that problem can happen because that would prevent optimizer from using indexes efficiently.

## 3. Create Efficient Query Plans Using Query Store

## 4. Compare Estimated and Actual Query Plans and Related Metadata

## 5. Configure Azure SQL Database Performance Insight

## Summary
